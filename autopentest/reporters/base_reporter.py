"""
Base Reporter - 报告生成器基类
"""
from abc import ABC, abstractmethod
from typing import Dict, Any, List
from datetime import datetime


class BaseReporter(ABC):
    """
    报告生成器基类，所有报告生成器都应继承此类
    """

    def __init__(self, poc_recorder):
        """
        初始化报告生成器

        Args:
            poc_recorder: PoCRecorder 实例
        """
        self.poc_recorder = poc_recorder
        self.scan_time = datetime.now()

    @abstractmethod
    def generate(self, output_path: str, target: str,
                metadata: Dict[str, Any] = None):
        """
        生成报告

        Args:
            output_path: 输出文件路径
            target: 目标信息
            metadata: 额外的元数据
        """
        pass

    def _get_report_data(self, target: str,
                        metadata: Dict[str, Any] = None) -> Dict[str, Any]:
        """
        获取报告数据

        Args:
            target: 目标信息
            metadata: 额外的元数据

        Returns:
            报告数据字典
        """
        vulnerabilities = self.poc_recorder.get_all_vulnerabilities()
        stats = self.poc_recorder.get_statistics()

        return {
            'target': target,
            'scan_time': self.scan_time.isoformat(),
            'metadata': metadata or {},
            'statistics': stats,
            'vulnerabilities': vulnerabilities
        }

    def _calculate_risk_score(self, stats: Dict[str, Any]) -> int:
        """
        计算风险分数

        Args:
            stats: 统计信息

        Returns:
            风险分数 (0-100)
        """
        severity_weights = {
            'CRITICAL': 10,
            'HIGH': 7,
            'MEDIUM': 4,
            'LOW': 1
        }

        score = 0
        for severity, count in stats.get('by_severity', {}).items():
            score += severity_weights.get(severity, 0) * count

        return min(score, 100)

    def _get_risk_level(self, score: int) -> str:
        """
        根据分数获取风险等级

        Args:
            score: 风险分数

        Returns:
            风险等级字符串
        """
        if score >= 70:
            return 'CRITICAL'
        elif score >= 50:
            return 'HIGH'
        elif score >= 30:
            return 'MEDIUM'
        elif score > 0:
            return 'LOW'
        else:
            return 'NONE'
