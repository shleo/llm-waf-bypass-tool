"""
Settings - 全局配置
"""
import os
from typing import Optional, List


class Settings:
    """
    全局配置类
    """

    # 默认配置
    DEFAULT_TIMEOUT = 10
    DEFAULT_MAX_RETRIES = 3
    DEFAULT_USER_AGENT = 'AutoPentest/1.0'

    # LLM 配置
    LLM_PROVIDER = os.getenv('LLM_PROVIDER', 'openai')
    LLM_API_KEY = os.getenv('LLM_API_KEY', '')
    LLM_MODEL = os.getenv('LLM_MODEL', 'gpt-4')
    LLM_BASE_URL = os.getenv('LLM_BASE_URL', '')
    LLM_TEMPERATURE = float(os.getenv('LLM_TEMPERATURE', '0.7'))
    LLM_MAX_TOKENS = int(os.getenv('LLM_MAX_TOKENS', '2000'))

    # 代理配置
    PROXY = os.getenv('HTTP_PROXY', '')

    # 报告配置
    REPORT_FORMAT = os.getenv('REPORT_FORMAT', 'json')  # json, html, both
    OUTPUT_DIR = os.getenv('OUTPUT_DIR', './reports')

    # 扫描配置
    ENABLE_LLM_ANALYSIS = os.getenv('ENABLE_LLM_ANALYSIS', 'true').lower() == 'true'
    SCAN_CONCURRENCY = int(os.getenv('SCAN_CONCURRENCY', '5'))

    # 日志配置
    LOG_LEVEL = os.getenv('LOG_LEVEL', 'INFO')
    LOG_FILE = os.getenv('LOG_FILE', 'autopentest.log')

    # SQL 注入配置
    SQLI_PAYLOADS_ENABLED = True
    SQLI_TEST_ERROR_BASED = True
    SQLI_TEST_BOOLEAN_BASED = True
    SQLI_TEST_TIME_BASED = True
    SQLI_TEST_UNION_BASED = True

    # 常见测试端点
    COMMON_TEST_ENDPOINTS = [
        '/login',
        '/user/login',
        '/auth/login',
        '/api/user/login',
        '/api/login',
        '/admin',
        '/admin/login',
        '/search',
        '/api/search',
        '/product',
        '/api/products',
        '/user',
        '/api/user',
        '/users',
        '/api/users',
    ]

    # 常见测试参数
    COMMON_TEST_PARAMS = [
        'id',
        'user',
        'username',
        'name',
        'search',
        'query',
        'q',
        'email',
        'password',
        'cat',
        'category',
        'page',
        'sort',
        'order',
        'filter',
    ]

    @classmethod
    def get_llm_config(cls) -> dict:
        """获取 LLM 配置"""
        return {
            'provider': cls.LLM_PROVIDER,
            'api_key': cls.LLM_API_KEY,
            'model': cls.LLM_MODEL,
            'base_url': cls.LLM_BASE_URL,
            'temperature': cls.LLM_TEMPERATURE,
            'max_tokens': cls.LLM_MAX_TOKENS,
        }

    @classmethod
    def validate(cls) -> List[str]:
        """
        验证配置

        Returns:
            错误信息列表（空列表表示配置有效）
        """
        errors = []

        if cls.ENABLE_LLM_ANALYSIS and not cls.LLM_API_KEY:
            errors.append('LLM analysis is enabled but LLM_API_KEY is not set')

        return errors
