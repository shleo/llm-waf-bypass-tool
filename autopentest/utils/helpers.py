"""
Helper functions
"""
from urllib.parse import urlparse, urlunparse
from typing import Optional


def parse_url(url: str) -> Optional[dict]:
    """
    解析 URL

    Args:
        url: URL 字符串

    Returns:
        解析后的 URL 组件字典，失败返回 None
    """
    try:
        parsed = urlparse(url)
        return {
            'scheme': parsed.scheme,
            'netloc': parsed.netloc,
            'hostname': parsed.hostname,
            'port': parsed.port,
            'path': parsed.path,
            'params': parsed.params,
            'query': parsed.query,
            'fragment': parsed.fragment,
        }
    except Exception:
        return None


def ensure_url(url: str, default_scheme: str = 'https') -> str:
    """
    确保 URL 包含 scheme

    Args:
        url: URL 字符串
        default_scheme: 默认 scheme

    Returns:
        完整的 URL
    """
    if not url:
        return url

    parsed = urlparse(url)
    if not parsed.scheme:
        return urlunparse((
            default_scheme,
            parsed.netloc or parsed.path,
            parsed.path if parsed.netloc else '',
            parsed.params,
            parsed.query,
            parsed.fragment
        ))

    return url


def normalize_url(url: str) -> str:
    """
    规范化 URL

    Args:
        url: URL 字符串

    Returns:
        规范化后的 URL
    """
    url = ensure_url(url)

    parsed = urlparse(url)

    # 移除默认端口
    hostname = parsed.hostname
    port = parsed.port

    netloc = hostname
    if port and port not in (80, 443):
        netloc = f"{hostname}:{port}"

    # 移除末尾的斜杠
    path = parsed.path.rstrip('/')

    return urlunparse((
        parsed.scheme,
        netloc,
        path or '/',
        parsed.params,
        parsed.query,
        parsed.fragment
    ))


def extract_domain(url: str) -> str:
    """
    从 URL 中提取域名

    Args:
        url: URL 字符串

    Returns:
        域名
    """
    parsed = urlparse(url)
    return parsed.netloc or parsed.path


def is_valid_url(url: str) -> bool:
    """
    检查 URL 是否有效

    Args:
        url: URL 字符串

    Returns:
        是否有效
    """
    try:
        result = urlparse(url)
        return all([result.scheme, result.netloc])
    except Exception:
        return False
