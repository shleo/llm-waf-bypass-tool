"""
Base Analyzer module - abstract base class for vulnerability analyzers
"""
from abc import ABC, abstractmethod
from typing import Dict, Any, List, Optional
from ..core.base_scanner import BaseScanner


class BaseAnalyzer(BaseScanner, ABC):
    """
    漏洞分析器基类，所有漏洞分析器都应继承此类
    """

    def __init__(self, target: str, requester, poc_recorder,
                 llm_client=None, logger=None):
        """
        初始化分析器

        Args:
            target: 目标域名或 URL
            requester: Requester 实例
            poc_recorder: PoCRecorder 实例
            llm_client: LLM 客户端实例（可选）
            logger: 日志记录器
        """
        super().__init__(target, requester, poc_recorder, logger)
        self.llm_client = llm_client

    def scan(self) -> List[Dict[str, Any]]:
        """实现基类的 scan 方法，调用 analyze"""
        return []

    @abstractmethod
    def analyze(self, endpoint: str, method: str = 'GET',
                params: Optional[Dict] = None,
                data: Optional[Dict] = None,
                headers: Optional[Dict] = None) -> List[Dict[str, Any]]:
        """
        分析指定端点是否存在漏洞

        Args:
            endpoint: 目标端点 URL
            method: HTTP 方法
            params: URL 参数
            data: 请求体数据
            headers: 请求头

        Returns:
            发现的漏洞列表
        """
        pass

    def _send_payload(self, url: str, method: str, payload: str,
                      param_name: str, params: Optional[Dict] = None,
                      data: Optional[Dict] = None,
                      headers: Optional[Dict] = None):
        """
        发送测试 payload

        Args:
            url: 目标 URL
            method: HTTP 方法
            payload: 测试 payload
            param_name: 要注入的参数名
            params: URL 参数
            data: 请求体数据
            headers: 请求头

        Returns:
            (response, elapsed_time, modified_params/data)
        """
        modified_params = params.copy() if params else None
        modified_data = data.copy() if data else None

        # 将 payload 注入到指定参数
        if modified_params and param_name in modified_params:
            original_value = modified_params[param_name]
            modified_params[param_name] = f"{original_value}{payload}"
        elif modified_data and param_name in modified_data:
            original_value = modified_data[param_name]
            modified_data[param_name] = f"{original_value}{payload}"

        # 发送请求
        if method == 'GET':
            response, elapsed = self.requester.get(
                url, params=modified_params, headers=headers
            )
        else:  # POST
            response, elapsed = self.requester.post(
                url, data=modified_data, headers=headers
            )

        return response, elapsed, (modified_params or modified_data)
