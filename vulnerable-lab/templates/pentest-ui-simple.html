<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoPentest - LLM é©±åŠ¨çš„è‡ªåŠ¨åŒ–æ¸—é€æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5em;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-panel h2 {
            margin-bottom: 20px;
            color: #00d9ff;
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-field label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-size: 0.9em;
        }

        .input-field input, .input-field select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 0.95em;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        button {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-start {
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            color: #1a1a2e;
        }

        .btn-start:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-stop {
            background: linear-gradient(90deg, #ff4757, #ff6b81);
            color: white;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
            animation: pulse 2s infinite;
        }

        .status-dot.active {
            background: #00ff88;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .progress-container {
            flex: 1;
            max-width: 400px;
            margin: 0 20px;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            width: 0%;
            transition: width 0.5s;
        }

        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(255, 255, 255, 0.1);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border-left: 4px solid #666;
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .timeline-item.info { border-left-color: #00d9ff; }
        .timeline-item.success { border-left-color: #00ff88; }
        .timeline-item.error { border-left-color: #ff4757; }
        .timeline-item.warning { border-left-color: #ffa502; }
        .timeline-item.llm { border-left-color: #a855f7; }
        .timeline-item.blocked { border-left-color: #ff4757; }
        .timeline-item.http { border-left-color: #f59e0b; }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -27px;
            top: 25px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
            border: 2px solid #1a1a2e;
        }

        .timeline-item.info::before { background: #00d9ff; }
        .timeline-item.success::before { background: #00ff88; }
        .timeline-item.error::before { background: #ff4757; }
        .timeline-item.warning::before { background: #ffa502; }
        .timeline-item.llm::before { background: #a855f7; }
        .timeline-item.http::before { background: #f59e0b; }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .timeline-title {
            font-weight: 700;
            font-size: 1.1em;
            color: #00d9ff;
        }

        .timeline-time {
            color: #888;
            font-size: 0.85em;
        }

        /* HTTP æŠ¥æ–‡æ ·å¼ */
        .http-traffic {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            overflow: hidden;
            margin: 15px 0;
        }

        .http-request, .http-response {
            padding: 15px;
        }

        .http-request {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .http-label {
            font-weight: 700;
            margin-bottom: 10px;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            font-size: 0.85em;
        }

        .http-label.request {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .http-label.response {
            background: rgba(0, 217, 255, 0.2);
            color: #00d9ff;
        }

        .http-label.response-success {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .http-label.response-error {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }

        .http-status-line {
            color: #f59e0b;
            font-weight: 600;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }

        .http-headers {
            margin-bottom: 10px;
            font-size: 0.85em;
        }

        .http-header-line {
            padding: 4px 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.05);
        }

        .http-header-name {
            color: #a855f7;
            font-weight: 600;
        }

        .http-header-value {
            color: #e0e0e0;
            word-break: break-all;
        }

        .http-body {
            background: rgba(0, 0, 0, 0.5);
            padding: 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
            color: #ccc;
        }

        .http-body-empty {
            color: #666;
            font-style: italic;
        }

        /* è¯¦æƒ…æ ·å¼ */
        .detail-section {
            margin-top: 10px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.9em;
        }

        .detail-label {
            color: #888;
        }

        .detail-value {
            color: #e0e0e0;
            font-weight: 500;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .status-active { background: rgba(255, 71, 87, 0.2); color: #ff4757; }
        .status-success { background: rgba(0, 255, 136, 0.2); color: #00ff88; }

        .info-box {
            background: rgba(0, 217, 255, 0.1);
            border-left: 3px solid #00d9ff;
            padding: 10px 15px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .payload-box {
            background: rgba(0, 0, 0, 0.5);
            padding: 12px 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            margin: 10px 0;
            word-break: break-all;
            border-left: 3px solid #00ff88;
        }

        .llm-response {
            background: rgba(168, 85, 247, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 3px solid #a855f7;
        }

        .llm-label {
            color: #a855f7;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .response-box {
            background: rgba(255, 71, 87, 0.1);
            padding: 12px 15px;
            border-radius: 6px;
            font-size: 0.9em;
            margin: 10px 0;
            border-left: 3px solid #ff4757;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #00d9ff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 15px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .json-display {
            background: rgba(0, 0, 0, 0.5);
            padding: 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 250px;
            overflow-y: auto;
        }

        .json-key {
            color: #00d9ff;
        }

        .json-string {
            color: #00ff88;
        }

        .json-number {
            color: #ffa502;
        }

        .json-boolean {
            color: #ff4757;
        }

        .collapse-toggle {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 0;
            color: #00d9ff;
            font-size: 0.9em;
        }

        .collapse-toggle:hover {
            text-decoration: underline;
        }

        .collapsed-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsed-content.expanded {
            max-height: 2000px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ›¡ï¸ AutoPentest</h1>
            <p>LLM é©±åŠ¨çš„è‡ªåŠ¨åŒ–æ¸—é€æµ‹è¯•å¹³å° - è¯¦ç»† HTTP æŠ¥æ–‡å±•ç¤º</p>
        </header>

        <div class="control-panel">
            <h2>ğŸ¯ æµ‹è¯•é…ç½®</h2>
            <div class="input-group">
                <div class="input-field">
                    <label>ç›®æ ‡åœ°å€</label>
                    <input type="text" id="target" value="http://localhost:5000">
                </div>
                <div class="input-field">
                    <label>ç«¯ç‚¹è·¯å¾„</label>
                    <input type="text" id="endpoint" value="/api/cmd/user">
                </div>
                <div class="input-field">
                    <label>å‚æ•°å</label>
                    <input type="text" id="param" value="id">
                </div>
                <div class="input-field">
                    <label>å‚æ•°å€¼</label>
                    <input type="text" id="value" value="1">
                </div>
                <div class="input-field">
                    <label>æœ€å¤§è¿­ä»£æ¬¡æ•°</label>
                    <input type="number" id="iterations" value="5" min="1" max="10">
                </div>
            </div>
            <div class="button-group">
                <button class="btn-start" onclick="startTest()" id="startBtn">
                    ğŸš€ å¼€å§‹æµ‹è¯•
                </button>
                <button class="btn-stop" onclick="stopTest()" id="stopBtn" style="display: none;">
                    â¹ï¸ åœæ­¢æµ‹è¯•
                </button>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">å°±ç»ª</span>
            </div>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            <div id="iterationInfo"></div>
        </div>

        <div class="timeline" id="timeline">
            <div class="empty-state">
                <p>ç‚¹å‡»"å¼€å§‹æµ‹è¯•"å¯åŠ¨è‡ªåŠ¨åŒ–æ¸—é€æµ‹è¯•ï¼ŒæŸ¥çœ‹è¯¦ç»†çš„ HTTP æŠ¥æ–‡äº¤äº’</p>
            </div>
        </div>
    </div>

    <script>
        let currentTestId = null;
        let pollInterval = null;
        let processedEvents = 0;

        async function startTest() {
            const target = document.getElementById('target').value;
            const endpoint = document.getElementById('endpoint').value;
            const param = document.getElementById('param').value;
            const value = document.getElementById('value').value;
            const iterations = document.getElementById('iterations').value;

            document.getElementById('startBtn').disabled = true;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            document.getElementById('statusDot').classList.add('active');
            document.getElementById('statusText').textContent = 'æµ‹è¯•è¿›è¡Œä¸­...';
            document.getElementById('timeline').innerHTML = '';

            processedEvents = 0;

            try {
                const response = await fetch('/api/pentest/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        target,
                        endpoint,
                        param,
                        value,
                        max_iterations: parseInt(iterations)
                    })
                });

                const data = await response.json();
                if (data.success) {
                    currentTestId = data.test_id;
                    pollInterval = setInterval(pollStatus, 1000);
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                addTimelineItem('error', 'âŒ å¯åŠ¨å¤±è´¥', error.message);
                cleanup();
            }
        }

        async function stopTest() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
            cleanup();
        }

        async function pollStatus() {
            if (!currentTestId) return;

            try {
                const response = await fetch(`/api/pentest/status/${currentTestId}`);
                const data = await response.json();

                if (data.success) {
                    const newEvents = data.events.slice(processedEvents);
                    newEvents.forEach(event => {
                        processEvent(event);
                        processedEvents++;
                    });

                    updateProgress(data);

                    if (data.status === 'completed' || data.status === 'error') {
                        cleanup();
                        document.getElementById('statusDot').classList.remove('active');
                        document.getElementById('statusText').textContent =
                            data.status === 'completed' ? 'æµ‹è¯•å®Œæˆ' : 'æµ‹è¯•å‡ºé”™';
                    }
                }
            } catch (error) {
                console.error('Polling error:', error);
            }
        }

        function processEvent(event) {
            const type = event.type;
            const data = event.data;

            switch (type) {
                case 'init':
                    addTimelineItem('info', 'ğŸ¯ æµ‹è¯•åˆå§‹åŒ–',
                        `<div class="detail-section">
                            <div class="detail-row"><span class="detail-label">ç›®æ ‡æœåŠ¡å™¨:</span><span class="detail-value">${data.target}</span></div>
                            <div class="detail-row"><span class="detail-label">ç«¯ç‚¹è·¯å¾„:</span><span class="detail-value">${data.endpoint || '/'}</span></div>
                            <div class="detail-row"><span class="detail-label">LLM æ¨¡å‹:</span><span class="detail-value">${data.llm_model}</span></div>
                        </div>`);
                    break;

                case 'waf_test':
                    if (data.waf_active) {
                        addTimelineItem('info', 'ğŸ›¡ï¸ WAF æ£€æµ‹',
                            `<div class="status-badge status-active">WAF å·²å¯ç”¨</div>
                            <div class="info-box">ç›®æ ‡å— WAF ä¿æŠ¤ï¼Œå°†ä½¿ç”¨ LLM åŠ¨æ€ç”Ÿæˆç»•è¿‡ Payload</div>`);
                    } else {
                        addTimelineItem('warning', 'âš ï¸ WAF æœªå¯ç”¨',
                            `<div class="info-box">ç›®æ ‡æœªæ£€æµ‹åˆ° WAF</div>`);
                    }
                    break;

                case 'iteration_start':
                    addTimelineItem('info', `ğŸ”„ è¿­ä»£ ${data.iteration}`,
                        `<div class="detail-row"><span class="detail-label">è¿›åº¦:</span><span class="detail-value">${data.iteration}/${data.max_iterations || 5}</span></div>`);
                    break;

                case 'llm_response':
                    try {
                        const parsed = JSON.parse(data.response_preview);
                        addTimelineItem('llm', 'ğŸ§  LLM ç”Ÿæˆ Payload',
                            `<div class="llm-response">
                                <div class="llm-label">ğŸ”§ ç»•è¿‡æŠ€æœ¯: ${parsed.technique}</div>
                                <div style="color: #ccc; font-size: 0.9em; margin: 8px 0;">${parsed.explanation}</div>
                            </div>
                            <div class="payload-box">${parsed.payload}</div>`);
                    } catch (e) {
                        addTimelineItem('warning', 'ğŸ§  LLM å“åº”', data.response_preview.substring(0, 200));
                    }
                    break;

                case 'payload_test':
                    const testResult = data.test_result;
                    renderHTTPTraffic(testResult);
                    break;

                case 'scan_end':
                    const success = data.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥';
                    addTimelineItem(data.success ? 'success' : 'error', 'ğŸ“Š æµ‹è¯•å®Œæˆ',
                        `${success} | æ€»å°è¯•: ${data.attempts}`);
                    break;

                case 'error':
                    addTimelineItem('error', 'âŒ é”™è¯¯', data.message);
                    break;

                default:
                    // å¤„ç†åæ€äº‹ä»¶
                    if (type === 'reflection_trigger') {
                        addTimelineItem('warning', 'ğŸ¤” è§¦å‘åæ€åˆ†æ',
                            `<div class="info-box">
                                <div style="margin-bottom: 10px;"><strong>ğŸ“Š è¿­ä»£æ¬¡æ•°:</strong> ${data.iteration}</div>
                                <div style="margin-bottom: 10px;"><strong>âŒ å¤±è´¥æ¬¡æ•°:</strong> ${data.failed_attempts}</div>
                                <div><strong>ğŸ” åŸå› :</strong> ${data.reason}</div>
                            </div>
                            <div style="margin-top: 10px; color: #ffa502; font-size: 0.9em;">
                                â³ LLM æ­£åœ¨åˆ†æå¤±è´¥åŸå› å¹¶åˆ¶å®šæ–°ç­–ç•¥...
                            </div>`);
                    } else if (type === 'reflection_result') {
                        let strategies = data.new_strategies || [];
                        let strategiesList = strategies.map(s => `<li style="margin: 5px 0;">âœ¨ ${s}</li>`).join('');

                        addTimelineItem('llm', 'ğŸ’¡ åæ€åˆ†æç»“æœ',
                            `<div class="llm-response" style="border-left: 3px solid #ffa502;">
                                <div class="llm-label">ğŸ” WAF ç‰¹å¾åˆ†æ</div>
                                <div style="color: #ccc; font-size: 0.9em; margin: 8px 0;">${data.waf_characteristics || 'æœªçŸ¥'}</div>

                                <div class="llm-label" style="margin-top: 15px;">âŒ å¤±è´¥åŸå› </div>
                                <div style="color: #ccc; font-size: 0.9em; margin: 8px 0;">${data.failure_analysis || 'æœªçŸ¥'}</div>

                                <div class="llm-label" style="margin-top: 15px;">ğŸ¯ æ¨èæŠ€æœ¯</div>
                                <div style="color: #00ff88; font-size: 0.9em; margin: 8px 0;">${data.recommended_technique || 'æœªçŸ¥'}</div>

                                <div class="llm-label" style="margin-top: 15px;">ğŸ“‹ æ–°ç­–ç•¥åˆ—è¡¨</div>
                                <ul style="color: #ccc; font-size: 0.9em; margin: 8px 0; padding-left: 20px;">
                                    ${strategiesList || '<li>æ— </li>'}
                                </ul>

                                <div style="margin-top: 15px; padding: 8px 12px; background: rgba(255, 165, 2, 0.2); border-radius: 6px; font-size: 0.85em;">
                                    <strong>ğŸ“ˆ æˆåŠŸç‡è¯„ä¼°:</strong> ${data.confidence || 'æœªçŸ¥'}
                                </div>
                            </div>`);
                    } else if (type === 'reflection_start') {
                        addTimelineItem('warning', 'ğŸ¤” å¼€å§‹åæ€åˆ†æ',
                            `<div class="info-box">
                                <div><strong>ğŸ“Š å½“å‰è¿­ä»£:</strong> ${data.iteration}</div>
                                <div><strong>ğŸ” åˆ†æå¤±è´¥è®°å½•:</strong> ${data.analyzing_failures} æ¬¡</div>
                            </div>`);
                    } else if (type.match(/^iteration_\d+_parsed$/)) {
                        const reflectionBadge = data.based_on_reflection ?
                            '<div style="margin-top: 10px; padding: 5px 10px; background: rgba(255, 165, 2, 0.2); border-radius: 4px; font-size: 0.85em; color: #ffa502;">ğŸ’¡ åŸºäºåæ€åˆ†æç”Ÿæˆ</div>' : '';

                        addTimelineItem('llm', 'ğŸ§  LLM ç”Ÿæˆ Payload',
                            `<div class="llm-response">
                                <div class="llm-label">ğŸ”§ ç»•è¿‡æŠ€æœ¯: ${data.technique}</div>
                                <div style="color: #ccc; font-size: 0.9em; margin: 8px 0;">${data.explanation}</div>
                            </div>
                            ${reflectionBadge}
                            <div class="payload-box">${data.payload}</div>`);
                    } else if (type.match(/^iteration_\d+_test$/)) {
                        // æ˜¾ç¤ºè¯¦ç»†çš„æµ‹è¯•ç»“æœ
                        let statusColor = data.waf_blocked ? '#ff4444' : (data.status_code >= 400 ? '#ff9800' : '#4caf50');
                        let statusText = data.waf_blocked ? 'âŒ WAF æ‹¦æˆª' :
                                       (data.status_code >= 400 ? `âš ï¸ HTTP ${data.status_code}` :
                                       (data.has_data ? 'âœ… æœ‰æ•°æ®è¿”å›' : 'â³ æ— é¢å¤–æ•°æ®'));

                        let detailHtml = `<div class="info-box">`;
                        detailHtml += `<div style="margin-bottom: 8px;"><strong>çŠ¶æ€:</strong> <span style="color: ${statusColor};">${statusText}</span></div>`;
                        detailHtml += `<div style="margin-bottom: 8px;"><strong>HTTP çŠ¶æ€ç :</strong> ${data.status_code}</div>`;
                        detailHtml += `<div style="margin-bottom: 8px;"><strong>æ•°æ®æ¡æ•°:</strong> ${data.data_count}</div>`;
                        if (data.waf_reason) {
                            detailHtml += `<div style="margin-bottom: 8px;"><strong>WAF åŸå› :</strong> ${data.waf_reason}</div>`;
                        }
                        if (data.error) {
                            detailHtml += `<div style="margin-bottom: 8px; padding: 8px; background: rgba(255,0,0,0.1); border-radius: 4px;">`;
                            detailHtml += `<div style="margin-bottom: 4px;"><strong style="color: #ff4444;">é”™è¯¯ä¿¡æ¯:</strong></div>`;
                            detailHtml += `<div style="font-size: 0.85em; font-family: monospace;">${data.error}</div>`;
                            detailHtml += `</div>`;
                        }
                        detailHtml += `</div>`;

                        addTimelineItem('waf', `ğŸ§ª æµ‹è¯• Payload - ${statusText}`, detailHtml);
                    } else if (type.match(/^iteration_\d+_parse_error$/)) {
                        addTimelineItem('warning', 'âš ï¸ LLM è§£æå¤±è´¥',
                            `<div class="info-box">
                                <div style="margin-bottom: 10px;"><strong>é”™è¯¯:</strong> ${data.error || 'æœªçŸ¥é”™è¯¯'}</div>
                                <div style="margin-bottom: 10px;"><strong>å“åº”é•¿åº¦:</strong> ${data.response_length || 0} å­—ç¬¦</div>
                                <div style="margin-bottom: 10px;"><strong>åŒ…å«èŠ±æ‹¬å·:</strong> ${data.contains_braces ? 'æ˜¯' : 'å¦'}</div>
                                <div style="margin-bottom: 10px;"><strong>åŒ…å« "payload":</strong> ${data.contains_payload ? 'æ˜¯' : 'å¦'}</div>
                                <div style="margin-bottom: 10px;"><strong>åŒ…å« "technique":</strong> ${data.contains_technique ? 'æ˜¯' : 'å¦'}</div>
                                <div style="margin-top: 10px;"><strong>å“åº”é¢„è§ˆ (å‰500å­—ç¬¦):</strong></div>
                                <pre style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 200px; font-size: 0.85em;">${data.response_preview || 'æ— '}</pre>
                                <div style="margin-top: 10px; color: #ff6b6b; font-size: 0.85em;">${data.debug_info || ''}</div>
                            </div>`);
                    } else if (type.match(/^iteration_\d+_llm_raw$/)) {
                        // æ˜¾ç¤ºå®Œæ•´çš„ LLM å“åº”ç”¨äºè°ƒè¯•
                        addTimelineItem('debug', 'ğŸ” LLM å®Œæ•´å“åº”',
                            `<div class="info-box">
                                <div style="margin-bottom: 10px;"><strong>å“åº”é•¿åº¦:</strong> ${data.response_length} å­—ç¬¦</div>
                                <div style="margin-bottom: 10px;"><strong>å®Œæ•´å“åº”:</strong></div>
                                <pre style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 400px; font-size: 0.85em; white-space: pre-wrap;">${data.full_response}</pre>
                            </div>`);
                    } else if (type.match(/^iteration_\d+_start$/)) {
                        addTimelineItem('info', `ğŸ”„ è¿­ä»£ ${data.iteration}`,
                            `<div class="detail-row"><span class="detail-label">è¿›åº¦:</span><span class="detail-value">è¿­ä»£ ${data.iteration}</span></div>`);
                    } else if (type.match(/^iteration_\d+_response_analysis$/)) {
                        // æ˜¾ç¤ºå“åº”åˆ†æï¼ˆåŒ…å«æ›´å¤šè°ƒè¯•ä¿¡æ¯ï¼‰
                        const dataPreview = data.data_preview || [];
                        let previewHtml = '';
                        if (dataPreview.length > 0) {
                            previewHtml = '<div style="margin-top: 10px;"><strong>æ•°æ®é¢„è§ˆ:</strong></div>';
                            previewHtml += '<pre style="background: rgba(0,255,0,0.1); padding: 8px; border-radius: 4px; margin-top: 5px; max-height: 150px; overflow: auto; font-size: 0.85em;">' +
                                        JSON.stringify(dataPreview, null, 2) + '</pre>';
                        }

                        let debugInfo = '';
                        if (data.data_list_type) {
                            debugInfo += `<div style="margin-bottom: 4px;"><strong>åˆ—è¡¨ç±»å‹:</strong> ${data.data_list_type}</div>`;
                        }
                        if (data.first_item_type) {
                            debugInfo += `<div style="margin-bottom: 4px;"><strong>é¦–é¡¹ç±»å‹:</strong> ${data.first_item_type}</div>`;
                        }

                        addTimelineItem('debug', 'ğŸ“Š å“åº”åˆ†æ',
                            `<div class="info-box">
                                <div style="margin-bottom: 8px;"><strong>æ•°æ®æ¡æ•°:</strong> ${data.data_count}</div>
                                <div style="margin-bottom: 8px;"><strong>å“åº”å­—æ®µ:</strong> ${data.response_keys ? data.response_keys.join(', ') : 'N/A'}</div>
                                ${debugInfo}
                                ${previewHtml}
                            </div>`);
                    } else if (type.match(/^iteration_\d+_debug_item_\d+$/)) {
                        // æ˜¾ç¤ºéå­—å…¸é¡¹ç›®çš„è°ƒè¯•ä¿¡æ¯
                        addTimelineItem('warning', 'âš ï¸ æ•°æ®é¡¹ç±»å‹è­¦å‘Š',
                            `<div class="info-box" style="background: rgba(255,152,0,0.1);">
                                <div style="margin-bottom: 8px;"><strong>è­¦å‘Š:</strong> ${data.warning}</div>
                                <div style="margin-bottom: 4px;"><strong>ç±»å‹:</strong> ${data.item_type}</div>
                                <div style="margin-bottom: 4px;"><strong>å€¼:</strong></div>
                                <pre style="background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; max-height: 100px; overflow: auto; font-size: 0.85em;">${data.item_value}</pre>
                            </div>`);
                    } else if (type.match(/^iteration_\d+_debug_item_error_\d+$/)) {
                        // æ˜¾ç¤ºå¤„ç†æ•°æ®é¡¹æ—¶çš„é”™è¯¯
                        addTimelineItem('error', 'âŒ æ•°æ®é¡¹å¤„ç†é”™è¯¯',
                            `<div class="info-box" style="background: rgba(255,0,0,0.1);">
                                <div style="margin-bottom: 8px;"><strong>é”™è¯¯:</strong> ${data.error}</div>
                                <div style="margin-bottom: 4px;"><strong>ç±»å‹:</strong> ${data.item_type}</div>
                            </div>`);
                    } else if (type.match(/^iteration_\d+_http$/)) {
                        // æ˜¾ç¤º HTTP è¯·æ±‚å’Œå“åº”è¯¦æƒ…
                        const req = data.request || {};
                        const resp = data.response || {};
                        const statusColor = resp.waf_blocked ? '#ff4444' : (resp.status_code >= 400 ? '#ff9800' : '#4caf50');

                        let httpHtml = '<div class="info-box" style="font-size: 0.9em;">';

                        // HTTP è¯·æ±‚éƒ¨åˆ†
                        httpHtml += '<div style="margin-bottom: 12px;">';
                        httpHtml += '<div style="margin-bottom: 6px;"><strong style="color: #64b5f6;">ğŸ“¤ HTTP è¯·æ±‚</strong></div>';
                        httpHtml += '<div style="padding: 8px; background: rgba(100, 181, 246, 0.15); border-radius: 4px; border-left: 3px solid #64b5f6;">';
                        httpHtml += `<div style="margin-bottom: 4px;"><strong>æ–¹æ³•:</strong> <span style="color: #64b5f6;">${req.method || 'GET'}</span></div>`;
                        httpHtml += `<div style="margin-bottom: 4px;"><strong>URL:</strong></div>`;
                        httpHtml += `<div style="word-break: break-all; font-family: monospace; font-size: 0.85em; color: #b3e5fc;">${req.full_url || req.url || ''}</div>`;
                        httpHtml += `<div style="margin-top: 6px;"><strong>å‚æ•°:</strong> ${req.param_name || ''} = </div>`;
                        httpHtml += `<div style="word-break: break-all; font-family: monospace; font-size: 0.85em; color: #ffeb3b; background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 3px; margin-top: 4px;">${req.payload || ''}</div>`;
                        httpHtml += '</div></div>';

                        // HTTP å“åº”éƒ¨åˆ†
                        httpHtml += '<div style="margin-bottom: 12px;">';
                        httpHtml += '<div style="margin-bottom: 6px;"><strong style="color: #81c784;">ğŸ“¥ HTTP å“åº”</strong></div>';
                        httpHtml += '<div style="padding: 8px; background: rgba(129, 199, 132, 0.15); border-radius: 4px; border-left: 3px solid #81c784;">';

                        // çŠ¶æ€æŒ‡ç¤º
                        let statusText = resp.waf_blocked ? 'âŒ WAF æ‹¦æˆª' :
                                       (resp.status_code >= 400 ? `âš ï¸ HTTP ${resp.status_code}` : 'âœ… æˆåŠŸ');
                        httpHtml += `<div style="margin-bottom: 6px;"><strong>çŠ¶æ€:</strong> <span style="color: ${statusColor}; font-weight: bold;">${statusText}</span></div>`;

                        // HTTP çŠ¶æ€ç 
                        httpHtml += `<div style="margin-bottom: 4px;"><strong>çŠ¶æ€ç :</strong> <span style="color: ${statusColor};">${resp.status_code || 0}</span></div>`;

                        // WAF åŸå› 
                        if (resp.waf_reason) {
                            httpHtml += `<div style="margin-bottom: 6px;"><strong>WAF åŸå› :</strong> <span style="color: #ff4444;">${resp.waf_reason}</span></div>`;
                        }

                        httpHtml += '</div></div>';

                        // å“åº”ä½“è¯¦æƒ…
                        httpHtml += '<div style="margin-bottom: 8px;">';
                        httpHtml += '<div style="margin-bottom: 6px;"><strong style="color: #ba68c8;">ğŸ“„ å“åº”å†…å®¹</strong></div>';
                        httpHtml += '<div style="padding: 8px; background: rgba(186, 104, 200, 0.15); border-radius: 4px; border-left: 3px solid #ba68c8;">';

                        const body = resp.body || {};

                        // success å­—æ®µ
                        httpHtml += `<div style="margin-bottom: 4px;"><strong>success:</strong> ${body.success !== undefined ? body.success : true}</div>`;

                        // æ•°æ®æ¡æ•°
                        const dataList = body.data || [];
                        httpHtml += `<div style="margin-bottom: 4px;"><strong>æ•°æ®æ¡æ•°:</strong> ${dataList.length}</div>`;

                        // é”™è¯¯ä¿¡æ¯
                        if (body.error) {
                            httpHtml += `<div style="margin-bottom: 6px;"><strong style="color: #ff4444;">é”™è¯¯:</strong> <span style="color: #ff4444; font-size: 0.85em;">${body.error}</span></div>`;
                        }

                        // Query å­—æ®µ
                        if (body.query) {
                            httpHtml += `<div style="margin-bottom: 6px;"><strong>Query:</strong></div>`;
                            httpHtml += `<div style="word-break: break-all; font-family: monospace; font-size: 0.8em; background: rgba(0,0,0,0.3); padding: 6px; border-radius: 3px; margin-bottom: 6px;">${body.query}</div>`;
                        }

                        // æ•°æ®é¢„è§ˆï¼ˆæ˜¾ç¤ºå‰2æ¡ï¼‰
                        if (dataList.length > 0) {
                            httpHtml += `<div style="margin-bottom: 4px;"><strong>æ•°æ®é¢„è§ˆ:</strong></div>`;
                            const previewData = dataList.slice(0, 2);
                            httpHtml += `<pre style="background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; max-height: 150px; overflow: auto; font-size: 0.8em;">${JSON.stringify(previewData, null, 2)}</pre>`;
                            if (dataList.length > 2) {
                                httpHtml += `<div style="margin-top: 4px; font-size: 0.8em; color: #ccc;">... è¿˜æœ‰ ${dataList.length - 2} æ¡æ•°æ®</div>`;
                            }
                        }

                        httpHtml += '</div></div>';
                        httpHtml += '</div>';

                        addTimelineItem('info', `ğŸŒ HTTP é€šä¿¡ - ${statusText}`, httpHtml);
                    } else if (type.match(/^iteration_\d+_single_item_error$/)) {
                        // æ˜¾ç¤ºå¤„ç†å•æ¡æ•°æ®é¡¹æ—¶çš„é”™è¯¯
                        addTimelineItem('warning', 'âš ï¸ å•é¡¹æ•°æ®å¤„ç†é”™è¯¯',
                            `<div class="info-box" style="background: rgba(255,152,0,0.1);">
                                <div style="margin-bottom: 8px;"><strong>é”™è¯¯:</strong> ${data.error}</div>
                                <div style="margin-bottom: 4px;"><strong>ç±»å‹:</strong> ${data.item_type}</div>
                            </div>`);
                    } else if (type.match(/^iteration_\d+_data_processing_error$/)) {
                        // æ˜¾ç¤ºæ•°æ®å¤„ç†æ—¶çš„ä¸¥é‡é”™è¯¯
                        addTimelineItem('error', 'ğŸš¨ æ•°æ®å¤„ç†é”™è¯¯',
                            `<div class="info-box" style="background: rgba(255,0,0,0.15); border-left: 3px solid #f44336;">
                                <div style="margin-bottom: 8px;"><strong>é”™è¯¯:</strong> ${data.error}</div>
                                <div style="margin-bottom: 8px;"><strong>ç±»å‹:</strong> ${data.error_type}</div>
                                <div style="margin-bottom: 8px;"><strong>æ•°æ®åˆ—è¡¨é•¿åº¦:</strong> ${data.data_list_length}</div>
                                ${data.traceback ? `<div style="margin-top: 8px;"><strong>å †æ ˆ:</strong></div><pre style="background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; max-height: 200px; overflow: auto; font-size: 0.8em;">${data.traceback}</pre>` : ''}
                            </div>`);
                    } else if (type.match(/^iteration_\d+_llm_raw$/)) {
                        // æ˜¾ç¤ºå®Œæ•´çš„å“åº”åˆ†æï¼ŒåŒ…æ‹¬ SQL é”™è¯¯
                        let analysisHtml = '<div class="info-box">';
                        analysisHtml += `<div style="margin-bottom: 8px;"><strong>ğŸ—„ï¸ æ•°æ®åº“ç±»å‹:</strong> <span style="color: ${data.database_type !== 'æœªçŸ¥' ? '#4caf50' : '#ff9800'}">${data.database_type}</span></div>`;
                        analysisHtml += `<div style="margin-bottom: 8px;"><strong>ğŸ“Š æ•°æ®åº“ç‰ˆæœ¬:</strong> ${data.database_version}</div>`;
                        analysisHtml += `<div style="margin-bottom: 8px;"><strong>ğŸ”¢ å­—æ®µæ•°é‡:</strong> ${data.field_count}</div>`;
                        analysisHtml += `<div style="margin-bottom: 8px;"><strong>âœ… å·²æå–ä¿¡æ¯æ•°:</strong> ${data.extracted_info_count}</div>`;

                        // SQL é”™è¯¯æ˜¾ç¤º
                        if (data.sql_errors_count > 0) {
                            analysisHtml += `<div style="margin-top: 12px; padding: 8px; background: rgba(255,0,0,0.1); border-radius: 4px; border-left: 3px solid #f44336;">`;
                            analysisHtml += `<div style="margin-bottom: 8px;"><strong style="color: #f44336;">âŒ SQL é”™è¯¯ (${data.sql_errors_count})</strong></div>`;
                            if (data.sql_errors && data.sql_errors.length > 0) {
                                analysisHtml += '<div style="font-size: 0.9em; max-height: 200px; overflow: auto;">';
                                data.sql_errors.forEach((err, i) => {
                                    analysisHtml += `<div style="margin-bottom: 6px; padding: 6px; background: rgba(255,0,0,0.15); border-radius: 3px;">${i+1}. ${err}</div>`;
                                });
                                analysisHtml += '</div>';
                            }
                            analysisHtml += '</div>';
                        }

                        // æœ€è¿‘çš„é”™è¯¯è¯¦æƒ…ï¼ˆåªæ˜¾ç¤ºæœ€æ–°çš„ 1 ä¸ªï¼‰
                        if (data.recent_errors && data.recent_errors.length > 0) {
                            const err = data.recent_errors[0];  // åªå–ç¬¬ 1 ä¸ªï¼ˆæœ€æ–°çš„ï¼‰
                            analysisHtml += `<div style="margin-top: 12px;">`;
                            analysisHtml += `<div style="margin-bottom: 6px;"><strong>ğŸ” æœ€æ–°é”™è¯¯è¯¦æƒ…:</strong></div>`;
                            analysisHtml += `<div style="margin-bottom: 8px; padding: 8px; background: rgba(255,152,0,0.1); border-radius: 4px;">`;
                            analysisHtml += `<div style="margin-bottom: 4px;"><strong>HTTP ${err.status_code}</strong></div>`;
                            if (err.error) analysisHtml += `<div style="margin-bottom: 4px; font-size: 0.85em;">${err.error}</div>`;
                            if (err.query) analysisHtml += `<div style="margin-bottom: 4px; font-size: 0.85em;"><strong>Query:</strong> ${err.query}</div>`;
                            if (err.payload) analysisHtml += `<div style="font-size: 0.85em;"><strong>Payload:</strong> ${err.payload}</div>`;
                            analysisHtml += `</div></div>`;
                        }

                        // å·²æå–ä¿¡æ¯
                        if (data.extracted_info && data.extracted_info.length > 0) {
                            analysisHtml += `<div style="margin-top: 12px;"><strong>ğŸ“‹ å·²æå–ä¿¡æ¯:</strong></div>`;
                            analysisHtml += '<ul style="margin-top: 5px; padding-left: 20px; font-size: 0.9em;">';
                            data.extracted_info.forEach(info => {
                                analysisHtml += `<li style="margin-bottom: 4px; color: #4caf50;">${info}</li>`;
                            });
                            analysisHtml += '</ul>';
                        }

                        analysisHtml += '</div>';
                        addTimelineItem('debug', 'ğŸ”¬ å®Œæ•´å“åº”åˆ†æ', analysisHtml);
                    } else if (type === 'llm_config') {
                        // æ˜¾ç¤º LLM é…ç½®ä¿¡æ¯
                        addTimelineItem('info', 'âš™ï¸ LLM é…ç½®',
                            `<div class="info-box">
                                <div style="margin-bottom: 8px;"><strong>ğŸ¤– æ¨¡å‹:</strong> ${data.model}</div>
                                <div style="margin-bottom: 8px;"><strong>ğŸŒ Base URL:</strong> ${data.base_url}</div>
                                <div style="margin-bottom: 8px;"><strong>ğŸ“ Max Tokens:</strong> ${data.max_tokens}</div>
                                <div style="margin-bottom: 8px;"><strong>ğŸ”‘ API Key:</strong> ${data.api_key_configured ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}</div>
                            </div>`);
                    } else if (type === 'llm_error') {
                        // æ˜¾ç¤º LLM é”™è¯¯
                        let errorDetails = '';
                        if (data.error_type || data.error_code) {
                            errorDetails = `<div style="margin-bottom: 8px;"><strong>é”™è¯¯ç±»å‹:</strong> ${data.error_type || 'Unknown'}</div>`;
                            errorDetails += `<div style="margin-bottom: 8px;"><strong>é”™è¯¯ä»£ç :</strong> ${data.error_code || 'N/A'}</div>`;
                        }
                        if (data.error_message) {
                            errorDetails += `<div style="margin-bottom: 8px;"><strong>é”™è¯¯æ¶ˆæ¯:</strong></div>`;
                            errorDetails += `<pre style="background: rgba(255,0,0,0.2); padding: 8px; border-radius: 4px; margin-top: 5px;">${data.error_message}</pre>`;
                        }
                        if (data.details) {
                            errorDetails += `<div style="margin-bottom: 8px;"><strong>è¯¦ç»†ä¿¡æ¯:</strong> ${data.details}</div>`;
                        }
                        if (data.response_text) {
                            errorDetails += `<div style="margin-bottom: 8px;"><strong>å“åº”å†…å®¹:</strong></div>`;
                            errorDetails += `<pre style="background: rgba(255,0,0,0.2); padding: 8px; border-radius: 4px; margin-top: 5px; max-height: 150px; overflow: auto;">${data.response_text}</pre>`;
                        }

                        addTimelineItem('error', 'âŒ LLM è°ƒç”¨å¤±è´¥',
                            `<div class="info-box" style="border-left: 3px solid #ff4444;">
                                <div style="margin-bottom: 10px;"><strong>é”™è¯¯:</strong> ${data.error || 'Unknown error'}</div>
                                ${errorDetails}
                                <div style="margin-top: 10px; padding: 8px; background: rgba(255,68,68,0.2); border-radius: 4px; font-size: 0.85em;">
                                    ğŸ’¡ è¯·æ£€æŸ¥ API Keyã€Base URL å’Œæ¨¡å‹é…ç½®æ˜¯å¦æ­£ç¡®
                                </div>
                            </div>`);
                    } else if (type === 'llm_request') {
                        // æ˜¾ç¤º LLM è¯·æ±‚è¯¦æƒ…
                        addTimelineItem('debug', 'ğŸ“¤ LLM è¯·æ±‚',
                            `<div class="info-box">
                                <div style="margin-bottom: 8px;"><strong>ğŸ¤– æ¨¡å‹:</strong> ${data.model}</div>
                                <div style="margin-bottom: 8px;"><strong>ğŸŒ Endpoint:</strong> ${data.endpoint}</div>
                                <div style="margin-bottom: 8px;"><strong>ğŸ“ Max Tokens:</strong> ${data.max_tokens}</div>
                                <div style="margin-bottom: 8px;"><strong>ğŸ“ Prompt é•¿åº¦:</strong> ${data.prompt_length || 'N/A'} å­—ç¬¦</div>
                                <div style="margin-bottom: 8px;"><strong>ğŸ”‘ API Key:</strong> ${data.api_key_preview || 'N/A'}</div>
                                <div style="margin-top: 10px;"><strong>Prompt é¢„è§ˆ:</strong></div>
                                <pre style="background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; margin-top: 5px; max-height: 100px; overflow: auto; font-size: 0.85em;">${data.prompt_preview || 'N/A'}</pre>
                            </div>`);
                    }
                    break;
            }
        }

        function renderHTTPTraffic(testResult) {
            const isBlocked = testResult.blocked;
            const statusClass = isBlocked ? 'response-error' : 'response-success';

            // è§£æ URL å’Œè¯·æ±‚ä¿¡æ¯
            let url = testResult.full_url || '';
            let method = 'GET';
            let path = url;
            let queryParam = '';

            try {
                const urlObj = new URL(url);
                method = 'POST'; // æ ¹æ®å®é™…æµ‹è¯•æ–¹æ³•
                path = urlObj.pathname;
                queryParam = urlObj.search;
            } catch (e) {
                // URL è§£æå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹å€¼
            }

            // æ„å»ºè¯·æ±‚ä½“
            let requestBody = '';
            if (testResult.payload && path.includes('id=')) {
                requestBody = `id=${encodeURIComponent(testResult.payload)}`;
            }

            // æ„å»ºæ—¶é—´çº¿é¡¹
            const title = isBlocked ? 'ğŸš« Payload è¢«é˜»æ­¢' : 'âœ… ç»•è¿‡æˆåŠŸ';
            const itemClass = isBlocked ? 'blocked' : 'success';

            let html = `
                <div class="http-traffic">
                    <div class="http-request">
                        <div class="http-label request">ğŸ“¤ HTTP è¯·æ±‚</div>
                        <div class="http-status-line">${method} ${path}${queryParam} HTTP/1.1</div>
                        <div class="http-headers">
                            <div class="http-header-line">
                                <span class="http-header-name">Host:</span>
                                <span class="http-header-value">${testResult.url?.split('/')[2] || 'localhost:5000'}</span>
                            </div>
                            <div class="http-header-line">
                                <span class="http-header-name">User-Agent:</span>
                                <span class="http-header-value">AutoPentest/1.0</span>
                            </div>
                            <div class="http-header-line">
                                <span class="http-header-name">Content-Type:</span>
                                <span class="http-header-value">application/x-www-form-urlencoded</span>
                            </div>
                            <div class="http-header-line">
                                <span class="http-header-name">Accept:</span>
                                <span class="http-header-value">application/json, text/plain, */*</span>
                            </div>
                        </div>
                        ${requestBody ? `
                        <div style="margin-top: 10px;">
                            <div style="color: #f59e0b; font-weight: 600; margin-bottom: 5px; font-size: 0.9em;">è¯·æ±‚ä½“:</div>
                            <div class="http-body">${requestBody}</div>
                        </div>` : ''}
                    </div>
                    <div class="http-response">
                        <div class="http-label ${statusClass}">ğŸ“¥ HTTP å“åº”</div>
                        <div class="http-status-line">HTTP/1.1 ${testResult.status_code || '000'} ${getStatusText(testResult.status_code)}</div>
                        <div class="http-headers">
                            <div class="http-header-line">
                                <span class="http-header-name">Content-Type:</span>
                                <span class="http-header-value">application/json</span>
                            </div>
                            <div class="http-header-line">
                                <span class="http-header-name">Content-Length:</span>
                                <span class="http-header-value">${JSON.stringify(testResult.response || {}).length}</span>
                            </div>
                            ${isBlocked ? `
                            <div class="http-header-line">
                                <span class="http-header-name">X-WAF-Status:</span>
                                <span class="http-header-value" style="color: #ff4757;">BLOCKED</span>
                            </div>` : ''}
                        </div>
                        <div style="margin-top: 10px;">
                            <div style="color: #00d9ff; font-weight: 600; margin-bottom: 5px; font-size: 0.9em;">å“åº”ä½“:</div>
                            ${testResult.response ? `
                                <div class="collapse-toggle" onclick="toggleCollapse(this)">
                                    <span>â–¶</span> å±•å¼€æŸ¥çœ‹å®Œæ•´å“åº”
                                </div>
                                <div class="collapsed-content">
                                    <div class="http-body">${formatJSON(testResult.response)}</div>
                                </div>
                            ` : '<div class="http-body http-body-empty">(æ— å“åº”ä½“)</div>'}
                        </div>
                    </div>
                </div>
                ${isBlocked ? `
                <div class="response-box" style="margin-top: 15px;">
                    <strong>ğŸš« é˜»æ­¢åŸå› :</strong> ${testResult.waf_reason || 'Unknown'}<br>
                    <strong>ğŸ“ æ£€æµ‹è§„åˆ™:</strong> ${testResult.waf_stats?.pattern || 'SQLæ³¨å…¥æ¨¡å¼'}
                </div>` : `
                <div style="margin-top: 15px; padding: 12px; background: rgba(0, 255, 136, 0.1); border-radius: 6px; border-left: 3px solid #00ff88;">
                    <strong>âœ… æˆåŠŸç»•è¿‡ WAF!</strong>
                </div>`}
            `;

            addTimelineItem(itemClass, title, html);
        }

        function addTimelineItem(type, title, content) {
            const timeline = document.getElementById('timeline');
            const item = document.createElement('div');
            item.className = `timeline-item ${type}`;

            const time = new Date().toLocaleTimeString();
            item.innerHTML = `
                <div class="timeline-header">
                    <span class="timeline-title">${title}</span>
                    <span class="timeline-time">${time}</span>
                </div>
                ${content}
            `;

            timeline.appendChild(item);
            item.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function updateProgress(data) {
            const iterationEvents = data.events.filter(e => e.type === 'iteration_start');
            if (iterationEvents.length > 0) {
                const lastIteration = iterationEvents[iterationEvents.length - 1].data;
                const current = lastIteration.iteration || 1;
                const max = lastIteration.max_iterations || 5;
                const progress = ((current - 1) / max) * 100;
                document.getElementById('progressFill').style.width = `${progress}%`;
                document.getElementById('iterationInfo').textContent = `${current}/${max}`;
            }
        }

        function getStatusText(statusCode) {
            const statusMap = {
                200: 'OK',
                201: 'Created',
                400: 'Bad Request',
                403: 'Forbidden',
                404: 'Not Found',
                500: 'Internal Server Error',
                502: 'Bad Gateway',
                503: 'Service Unavailable'
            };
            return statusMap[statusCode] || 'Unknown';
        }

        function formatJSON(obj) {
            if (typeof obj === 'string') {
                try {
                    obj = JSON.parse(obj);
                } catch (e) {
                    return obj;
                }
            }
            return JSON.stringify(obj, null, 2)
                .replace(/"([^"]+)":/g, '<span class="json-key">"$1":</span>')
                .replace(/: "([^"]+)"/g, ': <span class="json-string">"$1"</span>')
                .replace(/: (\d+)/g, ': <span class="json-number">$1</span>')
                .replace(/: (true|false)/g, ': <span class="json-boolean">$1</span>');
        }

        function toggleCollapse(element) {
            const content = element.nextElementSibling;
            const icon = element.querySelector('span');
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.textContent = 'â–¶';
            } else {
                content.classList.add('expanded');
                icon.textContent = 'â–¼';
            }
        }

        function cleanup() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            currentTestId = null;
        }
    </script>
</body>
</html>
